<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Pulse - Visualizer Musik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            color: white;
            font-family: 'Inter', sans-serif;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #controls {
            transition: opacity 0.3s ease;
        }
        #controls.hidden-ui {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <canvas id="visualizer"></canvas>

    <div id="controls" class="fixed inset-0 flex flex-col items-center justify-center z-10 p-6">
        <div class="glass p-8 rounded-3xl max-w-md w-full text-center space-y-6 shadow-2xl border border-white/10">
            <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500">
                Neon Pulse
            </h1>
            <p class="text-gray-400 text-sm">
                Pilih sumber audio untuk memulai visualisasi.
            </p>

            <div class="grid grid-cols-1 gap-3">
                <button id="systemBtn" class="flex items-center justify-between p-4 rounded-xl glass hover:bg-white/10 transition-all group border border-blue-500/30">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-500/20 rounded-lg group-hover:bg-blue-500/40 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <div class="text-left">
                            <span class="block font-medium">Audio Sistem</span>
                            <span class="block text-[10px] text-gray-400 italic">Spotify, YouTube, Desktop</span>
                        </div>
                    </div>
                </button>

                <button id="micBtn" class="flex items-center justify-between p-4 rounded-xl glass hover:bg-white/10 transition-all group border border-purple-500/20">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-purple-500/20 rounded-lg group-hover:bg-purple-500/40 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                            </svg>
                        </div>
                        <span class="font-medium text-left">Gunakan Mikrofon</span>
                    </div>
                </button>

                <div class="relative group">
                    <input type="file" id="fileInput" accept="audio/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20">
                    <div class="flex items-center justify-between p-4 rounded-xl glass group-hover:bg-white/10 transition-all border border-pink-500/20">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-pink-500/20 rounded-lg group-hover:bg-pink-500/40 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-pink-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                                </svg>
                            </div>
                            <span class="font-medium text-left">Pilih File MP3</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-2 p-3 bg-blue-500/10 rounded-xl border border-blue-500/20">
                <p class="text-[11px] text-blue-300 font-semibold uppercase">Instruksi Audio Sistem:</p>
                <p class="text-[10px] text-gray-400 leading-relaxed">
                    1. Klik "Audio Sistem"<br>
                    2. Pilih "Tab Browser" atau "Seluruh Layar"<br>
                    3. <span class="text-white underline">Penting:</span> Centang <b>"Bagikan audio sistem"</b> di bawah pilihan layar.<br>
                    4. Klik tombol Biru "Bagikan".
                </p>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');
        const controls = document.getElementById('controls');
        const micBtn = document.getElementById('micBtn');
        const systemBtn = document.getElementById('systemBtn');
        const fileInput = document.getElementById('fileInput');

        let audioCtx, analyser, source, dataArray, animationId;
        let isSetup = false;
        let currentTitle = "Menunggu Audio...";
        let currentArtist = "Pilih sumber untuk memulai";
        let lastBassIntensity = 0;
        const particles = [];

        class Particle {
            constructor(x, y, bassStrength) {
                this.x = x;
                this.y = y;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * (bassStrength / 40) + 1;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.size = Math.random() * 3 + 1;
                const hue = Math.random() * 100 + 220;
                this.color = `hsla(${hue}, 80%, 60%, ${Math.random() * 0.5 + 0.5})`;
                this.life = 1;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= 0.015;
            }
            draw(ctx) {
                ctx.fillStyle = this.color.replace(')', `,${this.life})`);
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        async function initAudio(type, file = null) {
            try {
                if (audioCtx) audioCtx.close();
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                if (type === 'mic') {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    source = audioCtx.createMediaStreamSource(stream);
                    currentTitle = "Input Mikrofon";
                    currentArtist = "Mendengarkan sekitar...";
                } 
                else if (type === 'system') {
                    if (!navigator.mediaDevices.getDisplayMedia) throw new Error("Tidak didukung browser ini.");
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: { echoCancellation: false, noiseSuppression: false } });
                    if (stream.getAudioTracks().length === 0) {
                        stream.getTracks().forEach(t => t.stop());
                        throw new Error("Kotak 'Bagikan audio sistem' tidak dicentang.");
                    }
                    stream.getVideoTracks().forEach(t => t.stop());
                    source = audioCtx.createMediaStreamSource(stream);
                    currentTitle = "Audio Sistem PC";
                    currentArtist = "Menangkap output suara...";
                }
                else if (type === 'file' && file) {
                    const audio = new Audio();
                    audio.src = URL.createObjectURL(file);
                    audio.crossOrigin = "anonymous";
                    source = audioCtx.createMediaElementSource(audio);
                    audio.play();
                    
                    let nameParts = file.name.replace(/\.[^/.]+$/, "").split(' - ');
                    if (nameParts.length >= 2) {
                        currentArtist = nameParts[0];
                        currentTitle = nameParts.slice(1).join(' - ');
                    } else {
                        currentTitle = nameParts[0];
                        currentArtist = "File Lokal";
                    }
                }

                source.connect(analyser);
                if (type === 'file') analyser.connect(audioCtx.destination);

                isSetup = true;
                controls.classList.add('hidden-ui');
                draw();
            } catch (err) {
                console.error(err);
                let message = "Akses ditolak.";
                if (err.name === "NotAllowedError") message = "Izin ditolak/dibatalkan.";
                if (err.message.includes("dicentang")) message = err.message;
                showError(message);
            }
        }

        function draw() {
            animationId = requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);

            ctx.fillStyle = 'rgba(5, 5, 5, 0.25)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.35;

            let sum = 0;
            for(let i = 0; i < 20; i++) sum += dataArray[i];
            const bassIntensity = sum / 20;
            const pulse = (bassIntensity / 255) * 70;

            if (bassIntensity > lastBassIntensity + 25 && bassIntensity > 80) {
                const spawnCount = Math.floor(bassIntensity / 40);
                for (let i = 0; i < spawnCount; i++) {
                    const spawnRadius = radius + pulse + Math.random() * 30;
                    const angle = Math.random() * Math.PI * 2;
                    particles.push(new Particle(
                        centerX + Math.cos(angle) * spawnRadius,
                        centerY + Math.sin(angle) * spawnRadius,
                        bassIntensity
                    ));
                }
            }
            lastBassIntensity = bassIntensity;

            particles.forEach((p, index) => {
                p.update();
                p.draw(ctx);
                if (p.life <= 0 || p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
                    particles.splice(index, 1);
                }
            });

            const bgGrad = ctx.createRadialGradient(centerX, centerY, 10, centerX, centerY, radius + pulse * 2.5);
            bgGrad.addColorStop(0, `hsla(260, 80%, 40%, ${0.1 + (pulse/250)})`);
            bgGrad.addColorStop(1, 'transparent');
            ctx.fillStyle = bgGrad;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius + pulse * 2.5, 0, Math.PI * 2);
            ctx.fill();

            const barCount = 120;
            for (let i = 0; i < barCount; i++) {
                const dataIndex = Math.floor((i / barCount) * (dataArray.length * 0.7));
                const val = dataArray[dataIndex];
                const barHeight = (val / 255) * (radius * 1.5) + 5;
                const angle = (i * (360 / barCount)) * (Math.PI / 180);

                const xStart = centerX + Math.cos(angle) * (radius + pulse);
                const yStart = centerY + Math.sin(angle) * (radius + pulse);
                const xEnd = centerX + Math.cos(angle) * (radius + pulse + barHeight);
                const yEnd = centerY + Math.sin(angle) * (radius + pulse + barHeight);

                ctx.strokeStyle = `hsla(${(i/barCount)*360}, 80%, 65%, 0.8)`;
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(xStart, yStart);
                ctx.lineTo(xEnd, yEnd);
                ctx.stroke();
            }

            if (isSetup) {
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                ctx.font = '700 28px Inter, sans-serif';
                ctx.fillStyle = 'white';
                ctx.shadowColor = 'rgba(168, 85, 247, 0.5)';
                ctx.shadowBlur = 10;
                ctx.fillText(currentTitle, centerX, centerY - 20);
                ctx.shadowBlur = 0;

                ctx.font = '500 18px Inter, sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.fillText(currentArtist, centerX, centerY + 20);
            }
        }

        micBtn.addEventListener('click', () => initAudio('mic'));
        systemBtn.addEventListener('click', () => initAudio('system'));
        fileInput.addEventListener('change', (e) => e.target.files[0] && initAudio('file', e.target.files[0]));

        window.addEventListener('click', (e) => {
            if (isSetup && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                controls.classList.toggle('hidden-ui');
            }
        });

        function showError(msg) {
            const errorDiv = document.createElement('div');
            errorDiv.className = "fixed top-10 left-1/2 -translate-x-1/2 glass px-6 py-4 rounded-2xl text-red-400 text-sm z-50 shadow-2xl border border-red-500/30 text-center max-w-xs";
            errorDiv.innerHTML = `<b>Error:</b><br>${msg}`;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }
    </script>
</body>
</html>
